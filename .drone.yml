kind: pipeline
name: build
# eu.gcr.io
# digitaloctober-nuxt
steps:
- name: inspect
  image: alpine
  commands:
  - printenv | sort
  - find -name Dockerfile -type f

- name: build-docker
  # image: plugins/docker
  image: plugins/gcr
  settings:
    repo: eu.gcr.io/digitaloctober-nuxt/${DRONE_REPO_NAME}
    # repo: kapb14/${DRONE_REPO_NAME}
    auto_tag: true
    dockerfile: src/Dockerfile
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
    json_key:
      from_secret: gcr_auth

- name: build-notify
  image: plugins/slack
  settings:
    room: drone
    webhook: 
      from_secret: slack_webhook_url

trigger:
  branch:
  - master

---
kind: pipeline
name: deploy
depends_on:
- build  
trigger:
  status:
    - success
steps:
- name: deploy
  image: quay.io/honestbee/drone-kubernetes
  kubernetes_server:
    from_secret: kubernetes_server_secret
  kubernetes_token:
    from_secret: kubernetes_token_secret
  namespace: default
  deployment: ${DRONE_REPO_NAME}
  repo: eu.gcr.io/digitaloctober-nuxt/${DRONE_REPO_NAME}
  container: my-container
  # tag: mytag
- name: publish-notify
  image: plugins/slack
  settings:
    room: drone
    webhook: 
      from_secret: slack_webhook_url
---
# kind: pipeline
# name: rollback
# depends_on:
# - deploy
# trigger:
#   status:
#     - failed
# steps:
# - name: rollback-deployment






